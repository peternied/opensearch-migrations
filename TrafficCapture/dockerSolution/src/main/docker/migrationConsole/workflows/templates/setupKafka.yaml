apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: kafka-setup-better
spec:
  entrypoint: cluster-deploy
  serviceAccountName: argo-workflow-executor

  templates:
    - name: cluster-deploy
      inputs:
        parameters:
          - name: kafka-name
      outputs:
        parameters:
          - name: kafka-name
            valueFrom:
              expression: "inputs.parameters['kafka-name']"
          - name: bootstrap-servers
            valueFrom:
              expression: >-
                tasks['deploy-kafka-cluster-kraft'].outputs.parameters['brokers']
          - name: cluster-ca-pem
            valueFrom:
              expression: >-
                tasks['export-cluster-ca'].outputs.parameters['cluster-ca-pem']
      dag:
        tasks:
          - name: deploy-kafka-node-pool
            template: deploy-kafka-node-pool
            arguments:
              parameters:
                - name: kafka-name
                  value: "{{inputs.parameters.kafka-name}}"

          - name: deploy-kafka-cluster-kraft
            template: deploy-kafka-cluster-kraft
            dependencies: [deploy-kafka-node-pool]
            arguments:
              parameters:
                - name: kafka-name
                  value: "{{inputs.parameters.kafka-name}}"

          - name: export-cluster-ca
            template: export-cluster-ca
            dependencies: [deploy-kafka-cluster-kraft]
            arguments:
              parameters:
                - name: kafka-name
                  value: "{{inputs.parameters.kafka-name}}"

    - name: deploy-kafka-node-pool
      inputs:
        parameters:
          - name: kafka-name
      resource:
        action: apply
        setOwnerReference: true
        manifest: |
          apiVersion: kafka.strimzi.io/v1beta2
          kind: KafkaNodePool
          metadata:
            name: dual-role
            labels:
              strimzi.io/cluster: {{inputs.parameters.kafka-name}}
          spec:
            replicas: 1
            roles:
              - controller
              - broker
            storage:
              type: jbod
              volumes:
                - id: 0
                  type: persistent-claim
                  size: 5Gi
                  deleteClaim: false
                  kraftMetadata: shared

    - name: deploy-kafka-cluster-kraft
      inputs:
        parameters:
          - name: kafka-name
      outputs:
        parameters:
          - name: brokers
            valueFrom:
              jsonPath: "{.status.listeners[].bootstrapServers}"
      resource:
        action: apply
        setOwnerReference: true
        successCondition: status.listeners
        manifest: |
          apiVersion: kafka.strimzi.io/v1beta2
          kind: Kafka
          metadata:
            name: {{inputs.parameters.kafka-name}}
            annotations:
              strimzi.io/node-pools: enabled
              strimzi.io/kraft: enabled
          spec:
            kafka:
              version: 3.9.0
              metadataVersion: 3.9-IV0
              readinessProbe:
                initialDelaySeconds: 1
                periodSeconds: 2
                timeoutSeconds: 2
                failureThreshold: 1
              livenessProbe:
                initialDelaySeconds: 1
                periodSeconds: 2
                timeoutSeconds: 2
                failureThreshold: 2
              listeners:
                - name: tls
                  port: 9093
                  type: internal
                  tls: true
                  authentication:
                    type: scram-sha-512
              authorization:
                type: simple
              config:
                auto.create.topics.enable: false
                offsets.topic.replication.factor: 1
                transaction.state.log.replication.factor: 1
                transaction.state.log.min.isr: 1
                default.replication.factor: 1
                min.insync.replicas: 1
            entityOperator:
                topicOperator: {}
                userOperator: {}

    - name: export-cluster-ca
      inputs:
        parameters:
          - name: kafka-name
      outputs:
        parameters:
          - name: cluster-ca-pem
            valueFrom:
              path: /tmp/ca.crt
      script:
        image: bitnami/kubectl:1.30
        command: [bash, -lc]
        source: |
          set -euo pipefail
          SECRET="{{inputs.parameters.kafka-name}}-cluster-ca-cert"
          # Extract PEM (base64-decoded) into a file for Argo to capture as a parameter.
          kubectl get secret "${SECRET}" -o jsonpath='{.data.ca\.crt}' \
            | base64 -d > /tmp/ca.crt

    - name: create-kafka-topic
      inputs:
        parameters:
          - name: kafka-name
          - name: topic-name
          - name: topic-partitions
            value: ""
            description: "Number of partitions for the created topic"
          - name: default-topic-partitions
            value: "1"
            description: "Default number of partitions for the created topic, which will be applied when the topic-partitions is empty or nil."
          - name: topic-replicas
            value: ""
            description: "Number of replicas for the created topic"
          - name: default-topic-replicas
            value: "1"
            description: "Default number of replicas for the created topic, which will be applied when the topic-replicas is empty or nil."
      outputs:
        parameters:
          - name: topic-name
            valueFrom:
              jsonPath: "{.status.topicName}"
      resource:
        action: apply
        setOwnerReference: true
        successCondition: status.topicName
        manifest: |
          apiVersion: kafka.strimzi.io/v1beta2
          kind: KafkaTopic
          metadata:
            name: {{inputs.parameters.topic-name}}
            labels:
              strimzi.io/cluster: {{inputs.parameters.kafka-name}}
          spec:
            partitions: {{=let v=inputs.parameters['topic-partitions']; (v==nil || v=='') ? inputs.parameters['default-topic-partitions'] : v}}
            replicas:   {{=let v=inputs.parameters['topic-replicas'];   (v==nil || v=='') ? inputs.parameters['default-topic-replicas']   : v}}
            config:
              retention.ms: 604800000
              segment.bytes: 1073741824

    - name: create-kafka-user
      inputs:
        parameters:
          - name: kafka-name
          - name: userName
          - name: userType
      outputs:
        parameters:
          - name: username
            valueFrom:
              jsonPath: "{.status.username}"
          - name: secret
            valueFrom:
              jsonPath: "{.status.secret}"
      resource:
        action: apply
        manifest: |
          apiVersion: kafka.strimzi.io/v1beta2
          kind: KafkaUser
          metadata:
            name: '{{inputs.parameters.userName}}'
            labels:
              strimzi.io/cluster: '{{inputs.parameters.kafka-name}}'
          spec:
            authentication:
              type: scram-sha-512
            authorization:
              type: simple
              acls:
                - operation: Describe
                  resource:
                    type: topic
                    name: '*'
                    patternType: literal
                - operation: Describe
                  resource:
                    type: group
                    name: '*'
                    patternType: literal
        setOwnerReference: true
        successCondition: status.username

    - name: createrequiredusers
      inputs:
        parameters:
          - name: kafka-name
      outputs:
        parameters:
          - name: captureProxyUsername
            valueFrom:
              expression: tasks.createCaptureProxyUser.outputs.parameters.username
          - name: replayerUsername
            valueFrom:
              expression: tasks.createReplayerUser.outputs.parameters.username
          - name: consoleUsername
            valueFrom:
              expression: tasks.createConsoleUser.outputs.parameters.username
          - name: captureProxySecret
            valueFrom:
              expression: tasks.createCaptureProxyUser.outputs.parameters.secret
          - name: replayerSecret
            valueFrom:
              expression: tasks.createReplayerUser.outputs.parameters.secret
          - name: consoleSecret
            valueFrom:
              expression: tasks.createConsoleUser.outputs.parameters.secret
      dag:
        tasks:
          - name: createCaptureProxyUser
            template: create-kafka-user
            arguments:
              parameters:
                - name: kafka-name
                  value: "{{inputs.parameters.kafka-name}}"
                - name: userName
                  value: "{{=inputs.parameters.kafka-name+'-capture-proxy'}}"
                - name: userType
                  value: capture-proxy
          - name: createReplayerUser
            template: create-kafka-user
            arguments:
              parameters:
                - name: kafka-name
                  value: "{{inputs.parameters.kafka-name}}"
                - name: userName
                  value: "{{=inputs.parameters.kafka-name+'-replayer'}}"
                - name: userType
                  value: replayer
          - name: createConsoleUser
            template: create-kafka-user
            arguments:
              parameters:
                - name: kafka-name
                  value: "{{inputs.parameters.kafka-name}}"
                - name: userName
                  value: "{{=inputs.parameters.kafka-name+'-console'}}"
                - name: userType
                  value: console
    - name: setup-kafka-with-users
      inputs:
        parameters:
          - name: kafka-name
      outputs:
        parameters:
          - name: kafka-name
            valueFrom:
              expression: inputs.parameters.kafka-name
          - name: bootstrapServers
            valueFrom:
              expression: tasks.deployCluster.outputs.parameters.bootstrap-servers
          - name: clusterCaPem
            valueFrom:
              expression: tasks.deployCluster.outputs.parameters.cluster-ca-pem
          - name: captureProxyUsername
            valueFrom:
              expression: tasks.createUsers.outputs.parameters.captureProxyUsername
          - name: replayerUsername
            valueFrom:
              expression: tasks.createUsers.outputs.parameters.replayerUsername
          - name: consoleUsername
            valueFrom:
              expression: tasks.createUsers.outputs.parameters.consoleUsername
          - name: captureProxySecret
            valueFrom:
              expression: tasks.createUsers.outputs.parameters.captureProxySecret
          - name: replayerSecret
            valueFrom:
              expression: tasks.createUsers.outputs.parameters.replayerSecret
          - name: consoleSecret
            valueFrom:
              expression: tasks.createUsers.outputs.parameters.consoleSecret
      dag:
        tasks:
          - name: deployCluster
            template: cluster-deploy
            arguments:
              parameters:
                - name: kafka-name
                  value: "{{inputs.parameters.kafka-name}}"
          - name: createUsers
            template: createrequiredusers
            arguments:
              parameters:
                - name: kafka-name
                  value: "{{inputs.parameters.kafka-name}}"
            dependencies:
              - deployCluster