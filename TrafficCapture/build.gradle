plugins {
    id 'jacoco'
    id 'org.owasp.dependencycheck' version '8.2.1'
    id 'io.freefair.lombok' version '8.6' apply false
}

allprojects {
    repositories {
        mavenCentral()
    }
}

subprojects {
    ext {
        versions = [
            netty: '4.0.1.Final',
            slf4j: '2.0.7',
            guava: '32.0.1-jre',
            log4j: '2.20.0',
            protobuf: '3.22.2',
            apacheHttp: '5.2.1',

            mockito: '4.6.1',
            msk_iam: '2.0.3'
        ]
    }

    apply plugin: 'java'
    apply plugin: 'maven-publish'
    task javadocJar(type: Jar, dependsOn: javadoc) {
        archiveClassifier.set('javadoc')
        from javadoc.destinationDir
    }
    task sourcesJar(type: Jar) {
        archiveClassifier.set('sources')
        from sourceSets.main.allSource
        duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    }
    def excludedProjects = [
            'buildSrc',
            'dockerSolution',
    ]
    if (!(project.name in excludedProjects)) {
        publishing {
            publications {
                mavenJava(MavenPublication) {
                    from components.java
                    artifact javadocJar
                    artifact sourcesJar


                    group = 'org.opensearch.migrations.trafficcapture'

                    // support -Dbuild.version, but include default
                    version = System.getProperty("build.version", "0.1.0")

                    // support -Dbuild.snapshot=false, but default to true
                    if (System.getProperty("build.snapshot", "true") == "true") {
                        version += "-SNAPSHOT"
                    }


                    pom {
                        name = project.name
                        description = 'Everything opensearch migrations'
                        url = 'http://github.com/opensearch-project/opensearch-migrations'

                        licenses {
                            license {
                                name = 'The Apache License, Version 2.0'
                                url = 'http://www.apache.org/licenses/LICENSE-2.0.txt'
                            }
                        }
                        developers {
                            developer {
                                name = "OpenSearch"
                                url = "https://github.com/opensearch-project/opensearch-migrations"
                            }
                        }
                        scm {
                            connection = "scm:git@github.com:opensearch-project/opensearch-migrations.git"
                            developerConnection = "scm:git@github.com:opensearch-project/opensearch-migrations.git"
                            url = "git@github.com:opensearch-project/opensearch-migrations.git"
                        }
                    }

                    // Suppress POM metadata warnings for test fixtures
                    suppressPomMetadataWarningsFor('testFixturesApiElements')
                    suppressPomMetadataWarningsFor('testFixturesRuntimeElements')
                }
            }
            repositories {
                maven { url = "${rootProject.buildDir}/repository"}
                maven {
                    url "https://aws.oss.sonatype.org/content/repositories/snapshots"
                    name = 'staging'
                }
            }
        }
    }
}

allprojects {
    apply plugin: 'java'
    apply plugin: 'jacoco'
    apply plugin: 'org.owasp.dependencycheck'


    dependencies {
        constraints {
            implementation('org.apache.logging.log4j:log4j-core:2.17.1')

            implementation('io.opentelemetry:opentelemetry-bom:1.34.1')
            implementation('io.opentelemetry:opentelemetry-exporter-otlp:1.34.1')
            implementation('io.opentelemetry.semconv:opentelemetry-semconv:1.23.1-alpha')

            implementation('org.apache.logging.log4j:log4j-bom:2.20.0')
            implementation('org.apache.logging.log4j:log4j-slf4j2-impl:2.20.0')

            implementation('com.google.protobuf:protobuf-java:3.22.2')


            implementation('com.squareup.okio:okio-jvm:3.4.0')
        }
    }

    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(11)
        }
    }

    jacoco {
        toolVersion = '0.8.11'
    }

    tasks.withType(Test) {
        // Provide way to exclude particular tests from CLI
        // e.g. ./gradlew test -PexcludeTests=**/KafkaProtobufConsumerLongTermTest*
        if (project.hasProperty('excludeTests')) {
            exclude project.property('excludeTests')
        }
        useJUnitPlatform {
            //  Disable parallel test execution, see MIGRATIONS-1666
            systemProperty 'junit.jupiter.execution.parallel.enabled', 'false'
        }
    }

    test {
        systemProperty 'disableMemoryLeakTests', 'true'
        useJUnitPlatform {
            excludeTags 'longTest'
        }
        jacoco {
            enabled = false
        }
    }

    task slowTest(type: Test) {
        systemProperty 'disableMemoryLeakTests', 'false'
        jacoco {
            enabled = true
        }
    }

    // Utility task to allow copying required libraries into a 'dependencies' folder for security scanning
    tasks.register('copyDependencies', Copy) {
        duplicatesStrategy = DuplicatesStrategy.EXCLUDE

        from configurations.runtimeClasspath
        into "${buildDir}/dependencies"
    }
}

jacocoTestReport {
    dependsOn subprojects*.slowTest
    additionalSourceDirs.from(files(subprojects.sourceSets.main.allSource.srcDirs))
    sourceDirectories.from(files(subprojects.sourceSets.main.allSource.srcDirs))
    classDirectories.from(files(subprojects.sourceSets.main.output))
    executionData.from(subprojects.collect {
        "${it.buildDir}/jacoco/slowTest.exec"
    })

    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: ['**/protos/**', '**/JMeterLoadTest**'])
        }))
    }

    reports {
        xml.required = true
        xml.destination file("${buildDir}/reports/jacoco/test/jacocoTestReport.xml")
        html.required = true
        html.destination file("${buildDir}/reports/jacoco/test/html")
    }
}

